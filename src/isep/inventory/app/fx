package src;
    
    import isep.inventory.app.dto.DashboardStats;
    import isep.inventory.app.entity.InventoryItem;
    import isep.inventory.app.entity.User;
    import isep.inventory.app.service.InventoryService;
    import javafx.application.Application;
    import javafx.collections.FXCollections;
    import javafx.collections.ObservableList;
    import javafx.geometry.Insets;
    import javafx.geometry.Pos;
    import javafx.scene.Scene;
    import javafx.scene.control.*;
    import javafx.scene.control.cell.PropertyValueFactory;
    import javafx.scene.layout.*;
    import javafx.stage.Stage;
    import javafx.scene.paint.Color;
    import javafx.scene.shape.Rectangle;
    
    import java.util.Optional;
  
    public class InventoryFXApp extends Application {
    
        private Stage primaryStage;
        private InventoryService inventoryService;
        private User currentUser;
        private ObservableList<InventoryItem> tableData;
        
        private Label totalStockLabel;
        private Label totalItemsLabel;
        private Label lowStockLabel;
        private TableView<InventoryItem> table;
    
        public static void main(String[] args) {
            launch(args);
        }
    
        @Override
        public void start(Stage primaryStage) {
            this.primaryStage = primaryStage;
            this.inventoryService = new InventoryService(); 
            this.tableData = FXCollections.observableArrayList();
    
            primaryStage.setTitle("ISEP Inventory Hub");
            
            // Start with Login Screen
            showLoginScreen();
        }
    
        /**
         * SCENE 1: LOGIN SCREEN
         */
        private void showLoginScreen() {
            VBox loginLayout = new VBox(15);
            loginLayout.setAlignment(Pos.CENTER);
            loginLayout.setPadding(new Insets(40));
            loginLayout.getStyleClass().add("login-container");
    
            Label titleLabel = new Label("ISEP Inventory Login");
            titleLabel.getStyleClass().add("title-label");
    
            TextField usernameField = new TextField();
            usernameField.setPromptText("Username (admin)");
            
            PasswordField passwordField = new PasswordField();
            passwordField.setPromptText("Password (password)");
    
            Button loginButton = new Button("Sign In");
            loginButton.getStyleClass().add("primary-button");
            loginButton.setMaxWidth(Double.MAX_VALUE);
    
            Label errorLabel = new Label();
            errorLabel.setTextFill(Color.RED);
    
            loginButton.setOnAction(e -> {
                String user = usernameField.getText();
                String pass = passwordField.getText();
    
                // Mock Authentication Logic
                if ("admin".equals(user) && "password".equals(pass)) {
                    this.currentUser = new User(1L, "admin", "hashed", "Admin User", "Manager");
                    showDashboardScreen();
                } else {
                    errorLabel.setText("Invalid credentials");
                }
            });
    
            loginLayout.getChildren().addAll(titleLabel, usernameField, passwordField, loginButton, errorLabel);
    
            Scene loginScene = new Scene(loginLayout, 400, 500);
            loadStyles(loginScene);
            primaryStage.setScene(loginScene);
            primaryStage.show();
        }
    
        /**
         * SCENE 2: DASHBOARD
         */
        private void showDashboardScreen() {
            BorderPane root = new BorderPane();
            root.getStyleClass().add("main-background");
    
            // --- TOP HEADER ---
            HBox header = new HBox(20);
            header.getStyleClass().add("header");
            header.setAlignment(Pos.CENTER_LEFT);
            header.setPadding(new Insets(15, 25, 15, 25));
    
            Label appTitle = new Label("ISEP Inventory Hub");
            appTitle.getStyleClass().add("header-title");
    
            Region spacer = new Region();
            HBox.setHgrow(spacer, Priority.ALWAYS);
    
            Label userLabel = new Label("Logged in as: " + currentUser.getName());
            userLabel.getStyleClass().add("user-label");
    
            Button logoutButton = new Button("Logout");
            logoutButton.getStyleClass().add("danger-button");
            logoutButton.setOnAction(e -> {
                currentUser = null;
                showLoginScreen();
            });
    
            header.getChildren().addAll(appTitle, spacer, userLabel, logoutButton);
            root.setTop(header);
    
            // --- CENTER CONTENT ---
            VBox content = new VBox(20);
            content.setPadding(new Insets(25));
    
            // 1. Stats Cards
            HBox statsContainer = new HBox(20);
            statsContainer.setAlignment(Pos.CENTER);
            
            totalStockLabel = new Label("0");
            totalItemsLabel = new Label("0");
            lowStockLabel = new Label("0");
    
            statsContainer.getChildren().addAll(
                createStatCard("Total Stock", totalStockLabel, "stat-card-blue"),
                createStatCard("Unique Items", totalItemsLabel, "stat-card-green"),
                createStatCard("Low Stock Alerts", lowStockLabel, "stat-card-yellow")
            );
    
            // 2. Toolbar (Search + Add)
            HBox toolbar = new HBox(15);
            toolbar.setAlignment(Pos.CENTER_LEFT);
    
            TextField searchField = new TextField();
            searchField.setPromptText("Search inventory...");
            searchField.setPrefWidth(300);
            searchField.textProperty().addListener((obs, oldVal, newVal) -> filterTable(newVal));
    
            Region toolbarSpacer = new Region();
            HBox.setHgrow(toolbarSpacer, Priority.ALWAYS);
    
            Button addButton = new Button("Add New Item");
            addButton.getStyleClass().add("primary-button");
            addButton.setOnAction(e -> showItemDialog(null));
    
            toolbar.getChildren().addAll(searchField, toolbarSpacer, addButton);
    
            // 3. Table
            table = new TableView<>();
            setupTable();
            VBox.setVgrow(table, Priority.ALWAYS);
    
            content.getChildren().addAll(statsContainer, toolbar, table);
            root.setCenter(content);
    
            // Finalize Scene
            Scene dashboardScene = new Scene(root, 1000, 700);
            loadStyles(dashboardScene);
            primaryStage.setScene(dashboardScene);
            primaryStage.centerOnScreen();
    
            // Initial Data Load
            refreshData();
        }
    
        // --- COMPONENT HELPERS ---
    
        private VBox createStatCard(String title, Label valueLabel, String styleClass) {
            VBox card = new VBox(10);
            card.getStyleClass().addAll("stat-card", styleClass);
            card.setPrefWidth(250);
            
            Label titleLbl = new Label(title);
            titleLbl.getStyleClass().add("stat-title");
            
            valueLabel.getStyleClass().add("stat-value");
            
            card.getChildren().addAll(titleLbl, valueLabel);
            return card;
        }
    
        @SuppressWarnings("unchecked")
        private void setupTable() {
            TableColumn<InventoryItem, String> nameCol = new TableColumn<>("Name");
            nameCol.setCellValueFactory(new PropertyValueFactory<>("name"));
    
            TableColumn<InventoryItem, String> skuCol = new TableColumn<>("SKU");
            skuCol.setCellValueFactory(new PropertyValueFactory<>("sku"));
    
            TableColumn<InventoryItem, Integer> qtyCol = new TableColumn<>("Quantity");
            qtyCol.setCellValueFactory(new PropertyValueFactory<>("quantity"));
    
            TableColumn<InventoryItem, String> locCol = new TableColumn<>("Location");
            locCol.setCellValueFactory(new PropertyValueFactory<>("location"));
    
            TableColumn<InventoryItem, String> statusCol = new TableColumn<>("Status");
            statusCol.setCellValueFactory(new PropertyValueFactory<>("status"));
            statusCol.setCellFactory(column -> new TableCell<InventoryItem, String>() {
                @Override
                protected void updateItem(String item, boolean empty) {
                    super.updateItem(item, empty);
                    if (empty || item == null) {
                        setText(null);
                        setStyle("");
                    } else {
                        setText(item);
                        // Basic inline styling for status (CSS allows more complex logic)
                        if (item.contains("Low")) setStyle("-fx-text-fill: #d97706; -fx-font-weight: bold;");
                        else if (item.contains("Out")) setStyle("-fx-text-fill: #dc2626; -fx-font-weight: bold;");
                        else setStyle("-fx-text-fill: #16a34a; -fx-font-weight: bold;");
                    }
                }
            });
    
            // Action Column (Edit/Delete)
            TableColumn<InventoryItem, Void> actionCol = new TableColumn<>("Actions");
            actionCol.setCellFactory(param -> new TableCell<InventoryItem, Void>() {
                private final Button editBtn = new Button("Edit");
                private final Button deleteBtn = new Button("Delete");
                private final HBox pane = new HBox(10, editBtn, deleteBtn);
    
                {
                    editBtn.getStyleClass().add("small-button");
                    deleteBtn.getStyleClass().add("small-danger-button");
                    editBtn.setOnAction(event -> showItemDialog(getTableView().getItems().get(getIndex())));
                    deleteBtn.setOnAction(event -> {
                        InventoryItem item = getTableView().getItems().get(getIndex());
                        deleteItem(item);
                    });
                }
    
                @Override
                protected void updateItem(Void item, boolean empty) {
                    super.updateItem(item, empty);
                    setGraphic(empty ? null : pane);
                }
            });
    
            table.getColumns().addAll(nameCol, skuCol, qtyCol, locCol, statusCol, actionCol);
            table.setColumnResizePolicy(TableView.CONSTRAINED_RESIZE_POLICY);
        }
    
        // --- LOGIC & DATA ---
    
        private void refreshData() {
            // 1. Fetch List
            tableData.setAll(inventoryService.findAll());
            table.setItems(tableData);
    
            // 2. Fetch Stats
            DashboardStats stats = inventoryService.getDashboardStats();
            totalStockLabel.setText(String.valueOf(stats.getTotalStock()));
            totalItemsLabel.setText(String.valueOf(stats.getTotalItems()));
            lowStockLabel.setText(String.valueOf(stats.getLowStockCount()));
        }
    
        private void filterTable(String query) {
            if (query == null || query.isEmpty()) {
                table.setItems(tableData);
            } else {
                ObservableList<InventoryItem> filtered = FXCollections.observableArrayList();
                String lowerCaseQuery = query.toLowerCase();
                for (InventoryItem item : tableData) {
                    if (item.getName().toLowerCase().contains(lowerCaseQuery) ||
                        item.getSku().toLowerCase().contains(lowerCaseQuery) ||
                        item.getLocation().toLowerCase().contains(lowerCaseQuery)) {
                        filtered.add(item);
                    }
                }
                table.setItems(filtered);
            }
        }
    
        private void deleteItem(InventoryItem item) {
            Alert alert = new Alert(Alert.AlertType.CONFIRMATION);
            alert.setTitle("Delete Item");
            alert.setHeaderText("Are you sure you want to delete " + item.getName() + "?");
            
            Optional<ButtonType> result = alert.showAndWait();
            if (result.isPresent() && result.get() == ButtonType.OK) {
                inventoryService.deleteById(item.getId());
                refreshData();
            }
        }
    
        private void showItemDialog(InventoryItem item) {
            Dialog<InventoryItem> dialog = new Dialog<>();
            dialog.setTitle(item == null ? "Add New Item" : "Edit Item");
            dialog.setHeaderText(null);
    
            // Set the button types
            ButtonType saveButtonType = new ButtonType("Save", ButtonBar.ButtonData.OK_DONE);
            dialog.getDialogPane().getButtonTypes().addAll(saveButtonType, ButtonType.CANCEL);
    
            // Create labels and fields
            GridPane grid = new GridPane();
            grid.setHgap(10);
            grid.setVgap(10);
            grid.setPadding(new Insets(20, 150, 10, 10));
    
            TextField nameField = new TextField();
            nameField.setPromptText("Name");
            TextField skuField = new TextField();
            skuField.setPromptText("SKU");
            TextField qtyField = new TextField();
            qtyField.setPromptText("Quantity");
            TextField locField = new TextField();
            locField.setPromptText("Location");
    
            if (item != null) {
                nameField.setText(item.getName());
                skuField.setText(item.getSku());
                qtyField.setText(String.valueOf(item.getQuantity()));
                locField.setText(item.getLocation());
            }
    
            grid.add(new Label("Name:"), 0, 0);
            grid.add(nameField, 1, 0);
            grid.add(new Label("SKU:"), 0, 1);
            grid.add(skuField, 1, 1);
            grid.add(new Label("Quantity:"), 0, 2);
            grid.add(qtyField, 1, 2);
            grid.add(new Label("Location:"), 0, 3);
            grid.add(locField, 1, 3);
    
            dialog.getDialogPane().setContent(grid);
            
            // Apply CSS to dialog
            DialogPane dialogPane = dialog.getDialogPane();
            dialogPane.getStylesheets().add(getClass().getResource("/styles.css").toExternalForm());
            dialogPane.getStyleClass().add("my-dialog");
    
            dialog.setResultConverter(dialogButton -> {
                if (dialogButton == saveButtonType) {
                    InventoryItem newItem = item != null ? item : new InventoryItem();
                    newItem.setName(nameField.getText());
                    newItem.setSku(skuField.getText());
                    newItem.setLocation(locField.getText());
                    try {
                        newItem.setQuantity(Integer.parseInt(qtyField.getText()));
                    } catch (NumberFormatException e) {
                        newItem.setQuantity(0);
                    }
                    return newItem;
                }
                return null;
            });
    
            Optional<InventoryItem> result = dialog.showAndWait();
            result.ifPresent(newItem -> {
                inventoryService.save(newItem);
                refreshData();
            });
        }
    
        private void loadStyles(Scene scene) {
            scene.getStylesheets().add(getClass().getResource("/styles.css").toExternalForm());
        }
    }
}


import java.lang.classfile.Label;
import java.util.Optional;

import javax.swing.plaf.synth.Region;
import javax.swing.table.TableColumn;
import javax.swing.text.TableView;
import javax.swing.text.TableView.TableCell;
